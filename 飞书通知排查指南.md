# 飞书通知排查指南

当 GitHub Actions 显示成功但飞书没有收到消息时，请按以下步骤排查：

## 🔍 排查步骤

### 步骤 1: 检查 GitHub Secrets 配置

1. **访问 GitHub 仓库设置**
   - 进入：`https://github.com/waynegxxx/TrendRadarfork/settings/secrets/actions`
   - 确认 `FEISHU_WEBHOOK_URL` 是否存在

2. **验证 Webhook URL 格式**
   - 飞书 Webhook URL 格式应为：`https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxxxxx`
   - 确保 URL 完整且没有多余的空格

3. **检查 Webhook 是否有效**
   - 在飞书群聊中，进入「群设置」→「群机器人」→ 找到你的机器人
   - 确认机器人状态为「已启用」
   - 如果机器人被删除或禁用，需要重新创建

### 步骤 2: 查看 GitHub Actions 日志

1. **访问 Actions 页面**
   - 进入：`https://github.com/waynegxxx/TrendRadarfork/actions`

2. **查看最新运行的日志**
   - 点击最新的运行记录
   - 展开「Run crawler」步骤
   - 查找以下关键信息：

   **检查点 1: 配置加载**
   ```
   通知渠道配置来源: 飞书(环境变量)
   ```
   如果显示「未配置任何通知渠道」，说明 `FEISHU_WEBHOOK_URL` 未设置

   **检查点 2: 通知发送**
   ```
   飞书消息分为 X 批次发送 [报告类型]
   发送飞书第 1/X 批次，大小：XXX 字节 [报告类型]
   飞书第 1/X 批次发送成功 [报告类型]
   ```
   如果看到「发送失败」或「发送出错」，说明 Webhook URL 有问题

   **检查点 3: 推送窗口控制**
   ```
   推送窗口控制：当前时间 XX:XX 不在推送时间窗口 XX:XX-XX:XX 内，跳过推送
   ```
   如果看到这个，说明推送时间窗口限制了发送

   **检查点 4: 每天只推一次**
   ```
   推送窗口控制：今天已推送过，跳过本次推送
   ```
   如果看到这个，说明今天已经推送过了

### 步骤 3: 检查配置文件

检查 `config/config.yaml` 中的以下配置：

#### 3.1 通知功能是否启用

```yaml
notification:
  enable_notification: true  # 必须是 true
```

#### 3.2 推送时间窗口

```yaml
notification:
  push_window:
    enabled: false  # 如果为 true，需要检查时间窗口
    time_range:
      start: "16:00"  # 推送开始时间（北京时间）
      end: "18:00"    # 推送结束时间（北京时间）
    once_per_day: true  # 如果为 true，每天只推送一次
```

**问题排查**：
- 如果 `enabled: true`，确认当前时间是否在时间窗口内
- 如果 `once_per_day: true`，确认今天是否已经推送过

#### 3.3 报告模式

```yaml
report:
  mode: "daily"  # 可选: "daily"|"incremental"|"current"
```

**不同模式的行为**：
- `daily`: 按时推送当日汇总（默认每小时）
- `incremental`: 只有新增新闻时才推送
- `current`: 按时推送当前榜单

如果使用 `incremental` 模式，可能因为没有新增新闻而不推送。

### 步骤 4: 检查是否有匹配的新闻

查看 Actions 日志中的统计信息：

```
匹配关键词统计:
- 关键词1: X 条
- 关键词2: Y 条
```

如果所有关键词的匹配数量都是 0，说明没有匹配的新闻，可能不会发送通知（取决于模式）。

### 步骤 5: 测试 Webhook URL

使用以下 Python 脚本测试 Webhook 是否有效：

```python
import requests
import json

# 替换为你的飞书 Webhook URL
webhook_url = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxxxxxxx"

payload = {
    "msg_type": "text",
    "content": {
        "text": "这是一条测试消息"
    }
}

try:
    response = requests.post(webhook_url, json=payload, timeout=10)
    print(f"状态码: {response.status_code}")
    print(f"响应: {response.text}")
    
    if response.status_code == 200:
        result = response.json()
        if result.get("StatusCode") == 0 or result.get("code") == 0:
            print("✅ Webhook 测试成功！")
        else:
            print(f"❌ Webhook 返回错误: {result}")
    else:
        print(f"❌ HTTP 错误: {response.status_code}")
except Exception as e:
    print(f"❌ 请求失败: {e}")
```

**运行方法**：
```bash
python test_feishu_webhook.py
```

如果测试失败，说明 Webhook URL 无效，需要重新创建。

### 步骤 6: 检查飞书机器人权限

1. **确认机器人是否在群内**
   - 进入飞书群聊
   - 查看群成员列表，确认机器人存在

2. **检查机器人权限**
   - 进入「群设置」→「群机器人」
   - 确认机器人有发送消息的权限

3. **检查群聊设置**
   - 确认群聊没有被设置为「免打扰」
   - 确认消息通知已开启

## 🛠️ 常见问题解决

### 问题 1: Actions 成功但没收到消息

**可能原因**：
- Webhook URL 配置错误或已失效
- 推送时间窗口限制
- 没有匹配的新闻（incremental 模式）

**解决方法**：
1. 检查 Actions 日志中的错误信息
2. 测试 Webhook URL 是否有效
3. 检查推送时间窗口配置
4. 查看是否有匹配的新闻

### 问题 2: 看到「发送失败」错误

**可能原因**：
- Webhook URL 格式错误
- Webhook URL 已失效
- 网络连接问题

**解决方法**：
1. 重新创建飞书机器人，获取新的 Webhook URL
2. 更新 GitHub Secrets 中的 `FEISHU_WEBHOOK_URL`
3. 检查网络连接（GitHub Actions 服务器可能无法访问飞书 API）

### 问题 3: 看到「跳过推送」消息

**可能原因**：
- 推送时间窗口限制
- 每天只推一次的限制

**解决方法**：
1. 修改 `config/config.yaml` 中的 `push_window` 配置
2. 将 `enabled` 设置为 `false` 以禁用时间窗口限制
3. 将 `once_per_day` 设置为 `false` 以允许多次推送

### 问题 4: 配置了但显示「未配置任何通知渠道」

**可能原因**：
- GitHub Secrets 中的 `FEISHU_WEBHOOK_URL` 未设置
- Secret 名称拼写错误（应该是 `FEISHU_WEBHOOK_URL`）

**解决方法**：
1. 检查 GitHub Secrets 中是否存在 `FEISHU_WEBHOOK_URL`
2. 确认 Secret 名称拼写正确（区分大小写）
3. 重新设置 Secret 值

## 📋 快速检查清单

- [ ] GitHub Secrets 中已设置 `FEISHU_WEBHOOK_URL`
- [ ] Webhook URL 格式正确（以 `https://open.feishu.cn/open-apis/bot/v2/hook/` 开头）
- [ ] 飞书机器人状态为「已启用」
- [ ] 机器人已添加到群聊中
- [ ] `config/config.yaml` 中 `enable_notification: true`
- [ ] 推送时间窗口配置正确（如果启用）
- [ ] Actions 日志中没有错误信息
- [ ] 有匹配的新闻（检查关键词配置）

## 🔧 调试技巧

### 1. 手动触发 Actions

在 GitHub Actions 页面点击「Run workflow」手动触发，这样可以立即看到结果。

### 2. 添加调试日志

如果需要更详细的日志，可以修改代码添加更多 `print` 语句：

```python
# 在 send_to_feishu 函数中添加
print(f"飞书 Webhook URL: {webhook_url[:50]}...")  # 只显示前50个字符
print(f"报告数据统计: {len(report_data['stats'])} 个关键词")
```

### 3. 检查飞书消息历史

在飞书群聊中查看消息历史，确认是否有消息发送记录。

## 📞 获取帮助

如果以上步骤都无法解决问题，请：

1. **收集信息**：
   - GitHub Actions 日志（完整输出）
   - `config/config.yaml` 配置（隐藏敏感信息）
   - 飞书 Webhook URL 测试结果

2. **提交 Issue**：
   - 在 GitHub 仓库中提交 Issue
   - 详细描述问题和已尝试的解决方法

3. **查看文档**：
   - 参考项目 README.md
   - 查看其他故障排查文档

